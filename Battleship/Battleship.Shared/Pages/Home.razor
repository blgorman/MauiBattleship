@page "/"

<PageTitle>Battleship</PageTitle>

<h1>Battleship</h1>
<p class="status">@statusMessage</p>

<div class="controls">
    <button class="btn btn-primary" type="button" @onclick="ResetGame">Restart</button>
    <span class="turn">@(gameOver ? "Game over" : playerTurn ? "Your turn" : "Computer turn")</span>
</div>

<div class="boards">
    <div class="board-wrapper">
        <h2>Your Fleet</h2>
        <div class="board" aria-label="Player board">
            @for (var row = 0; row < BoardSize; row++)
            {
                @for (var col = 0; col < BoardSize; col++)
                {
                    <button class="cell @GetPlayerCellClass(row, col)" disabled title="@DescribePlayerCell(row, col)"></button>
                }
            }
        </div>
        <div class="fleet-status" aria-label="Your fleet status">
            <h3>Your ships (@ShipsAfloat(_playerFleet) afloat)</h3>
            <ul>
                @foreach (var ship in _playerFleet)
                {
                    <li class="@GetShipStatusClass(ship)">Length @ship.Length - @(ship.IsSunk ? "Sunk" : "Afloat")</li>
                }
            </ul>
        </div>
    </div>
    <div class="board-wrapper">
        <h2>Enemy Waters</h2>
        <div class="board" aria-label="Computer board">
            @for (var row = 0; row < BoardSize; row++)
            {
                var rowIndex = row;
                @for (var col = 0; col < BoardSize; col++)
                {
                    var colIndex = col;
                    <button class="cell @GetComputerCellClass(rowIndex, colIndex)" type="button" title="@DescribeComputerCell(rowIndex, colIndex)" @onclick="() => FireAt(rowIndex, colIndex)"></button>
                }
            }
        </div>
        <div class="fleet-status" aria-label="Enemy fleet status">
            <h3>Computer ships (@ShipsAfloat(_computerFleet) afloat)</h3>
            <ul>
                @foreach (var ship in _computerFleet)
                {
                    <li class="@GetShipStatusClass(ship)">Length @ship.Length - @(ship.IsSunk ? "Sunk" : "Afloat")</li>
                }
            </ul>
        </div>
    </div>
</div>

@code {
    private const int BoardSize = 10;
    private readonly int[] _shipLengths = { 5, 4, 3, 3, 2 };
    private readonly Random _random = new();

    private CellState[,] _playerBoard = new CellState[BoardSize, BoardSize];
    private CellState[,] _computerBoard = new CellState[BoardSize, BoardSize];
    private List<Ship> _playerFleet = new();
    private List<Ship> _computerFleet = new();
    private readonly HashSet<(int Row, int Col)> _computerShots = new();

    private bool playerTurn = true;
    private bool gameOver;
    private string statusMessage = "Take your shot!";

    protected override void OnInitialized()
    {
        ResetGame();
    }

    private void ResetGame()
    {
        _playerBoard = new CellState[BoardSize, BoardSize];
        _computerBoard = new CellState[BoardSize, BoardSize];
        _computerShots.Clear();
        gameOver = false;
        playerTurn = true;
        statusMessage = "Take your shot!";

        _playerFleet = PlaceFleet(_playerBoard);
        _computerFleet = PlaceFleet(_computerBoard);
    }

    private List<Ship> PlaceFleet(CellState[,] board)
    {
        var fleet = new List<Ship>();

        foreach (var ship in _shipLengths)
        {
            var placed = false;
            while (!placed)
            {
                var horizontal = _random.Next(2) == 0;
                var row = horizontal ? _random.Next(BoardSize) : _random.Next(BoardSize - ship + 1);
                var col = horizontal ? _random.Next(BoardSize - ship + 1) : _random.Next(BoardSize);

                if (CanPlaceShip(board, ship, row, col, horizontal))
                {
                    var coordinates = new List<(int Row, int Col)>();
                    for (var i = 0; i < ship; i++)
                    {
                        var r = horizontal ? row : row + i;
                        var c = horizontal ? col + i : col;
                        board[r, c] = CellState.Ship;
                        coordinates.Add((r, c));
                    }

                    fleet.Add(new Ship(ship, coordinates));
                    placed = true;
                }
            }
        }

        return fleet;
    }

    private static bool CanPlaceShip(CellState[,] board, int length, int row, int col, bool horizontal)
    {
        for (var i = 0; i < length; i++)
        {
            var r = horizontal ? row : row + i;
            var c = horizontal ? col + i : col;

            if (board[r, c] != CellState.Empty)
            {
                return false;
            }
        }

        return true;
    }

    private async Task FireAt(int row, int col)
    {
        if (gameOver || !playerTurn)
        {
            return;
        }

        if (row < 0 || row >= BoardSize || col < 0 || col >= BoardSize)
        {
            statusMessage = "That shot is outside the board. Please pick a spot in the 10x10 grid.";
            return;
        }

        var cell = _computerBoard[row, col];
        if (cell is CellState.Hit or CellState.Miss)
        {
            statusMessage = "You already checked that coordinate.";
            return;
        }

        if (cell == CellState.Ship)
        {
            _computerBoard[row, col] = CellState.Hit;

            var ship = _computerFleet.First(s => s.Occupies(row, col));
            ship.RegisterHit(row, col);
            statusMessage = ship.IsSunk
                ? $"HIT: You sank the computer's length {ship.Length} ship!"
                : "HIT: Direct hit!";

            if (!HasShipsRemaining(_computerFleet))
            {
                gameOver = true;
                statusMessage = "You sank the computer's fleet!";
                return;
            }
        }
        else
        {
            _computerBoard[row, col] = CellState.Miss;
            statusMessage = "MISS: Splash... that was a miss.";
        }

        playerTurn = false;
        await ComputerTurn();
    }

    private async Task ComputerTurn()
    {
        if (gameOver)
        {
            return;
        }

        await Task.Delay(600);

        var shotTaken = false;
        while (!shotTaken)
        {
            var row = _random.Next(BoardSize);
            var col = _random.Next(BoardSize);

            if (_computerShots.Contains((row, col)))
            {
                continue;
            }

            _computerShots.Add((row, col));

            if (_playerBoard[row, col] == CellState.Ship)
            {
                _playerBoard[row, col] = CellState.Hit;
                var ship = _playerFleet.First(s => s.Occupies(row, col));
                ship.RegisterHit(row, col);
                var hitMessage = $"HIT: The computer hit your ship at {ConvertToCoordinate(row, col)}.";

                if (ship.IsSunk)
                {
                    statusMessage = $"HIT: The computer sank your length {ship.Length} ship at {ConvertToCoordinate(row, col)}.";
                }
                else
                {
                    statusMessage = hitMessage;
                }

                if (!HasShipsRemaining(_playerFleet))
                {
                    gameOver = true;
                    statusMessage = "The computer sank your fleet!";
                    return;
                }
            }
            else
            {
                _playerBoard[row, col] = CellState.Miss;
                statusMessage = $"MISS: The computer missed at {ConvertToCoordinate(row, col)}.";
            }

            shotTaken = true;
        }

        playerTurn = true;
    }

    private static bool HasShipsRemaining(IEnumerable<Ship> fleet)
    {
        return fleet.Any(ship => !ship.IsSunk);
    }

    private static string ConvertToCoordinate(int row, int col)
    {
        return $"{(char)('A' + row)}{col + 1}";
    }

    private string GetPlayerCellClass(int row, int col)
    {
        return _playerBoard[row, col] switch
        {
            CellState.Ship => "ship",
            CellState.Hit => "hit",
            CellState.Miss => "miss",
            _ => "sea"
        };
    }

    private string GetComputerCellClass(int row, int col)
    {
        return _computerBoard[row, col] switch
        {
            CellState.Hit => "hit",
            CellState.Miss => "miss",
            _ => "unknown"
        };
    }

    private string DescribePlayerCell(int row, int col)
    {
        return _playerBoard[row, col] switch
        {
            CellState.Ship => $"Ship at {ConvertToCoordinate(row, col)}",
            CellState.Hit => $"Your ship was hit at {ConvertToCoordinate(row, col)}",
            CellState.Miss => $"Computer missed at {ConvertToCoordinate(row, col)}",
            _ => $"Open water at {ConvertToCoordinate(row, col)}"
        };
    }

    private string DescribeComputerCell(int row, int col)
    {
        return _computerBoard[row, col] switch
        {
            CellState.Hit => $"Hit at {ConvertToCoordinate(row, col)}",
            CellState.Miss => $"Miss at {ConvertToCoordinate(row, col)}",
            _ => $"Launch at {ConvertToCoordinate(row, col)}"
        };
    }

    private static int ShipsAfloat(IEnumerable<Ship> fleet) => fleet.Count(ship => !ship.IsSunk);

    private static string GetShipStatusClass(Ship ship) => ship.IsSunk ? "ship-sunk" : "ship-afloat";

    private enum CellState
    {
        Empty,
        Ship,
        Hit,
        Miss
    }

    private class Ship
    {
        private readonly HashSet<(int Row, int Col)> _coordinates;
        private readonly HashSet<(int Row, int Col)> _hits = new();

        public Ship(int length, IEnumerable<(int Row, int Col)> coordinates)
        {
            Length = length;
            _coordinates = new HashSet<(int Row, int Col)>(coordinates);
        }

        public int Length { get; }
        public bool IsSunk => _hits.Count >= Length;

        public bool Occupies(int row, int col) => _coordinates.Contains((row, col));

        public void RegisterHit(int row, int col)
        {
            if (Occupies(row, col))
            {
                _hits.Add((row, col));
            }
        }
    }
}
